---
title: "Server Infrastructure"
sidebarTitle: "04 · Server Infrastructure"
description: "V3-only public API endpoint reference, EasyAF data layer architecture, what to delete and keep from NuGetGallery, authentication, storage, search, and non-functional requirements."
icon: "server"
---

The AIpkg server is derived from NuGetGallery but radically simplified. The public surface exposes only a V3 JSON API. OData V2, OWIN, Autofac, and all Razor view infrastructure are removed. The backend uses ASP.NET Core 10 Minimal APIs for the public V3 API, Blazor SSR for the web UI (see [spec 05](05-frontend-ui)), and EasyAF for the internal data layer and admin surface.

---

## Technology Stack

| Layer | Technology | Notes |
|-------|------------|-------|
| Runtime | .NET 10 | LTS release |
| Public API | ASP.NET Core 10 Minimal APIs | V3 endpoints only |
| Web UI | Blazor SSR + Interactive Server | See [spec 05](05-frontend-ui) |
| Admin API | OData Restier via EasyAF | Internal only; not on public surface |
| ORM | EF Core 10 (Database-First) | Entities generated by EasyAF tooling |
| Database schema | SQL Server Database Project (`.sqlproj`) | Source of truth for schema |
| Auth | GitHub OAuth + PBKDF2 API keys + OIDC | Port existing PBKDF2 system |
| Storage | Azure Blob Storage | Existing abstraction renamed `.nupkg` → `.aipkg` |
| Search | Azure AI Search | New `AipkgSearchDocument` model |
| DI | ASP.NET Core built-in DI | Autofac removed |
| Config | `appsettings.json` + environment variables | No custom XML config |
| CDN | Azure CDN | Keep existing stats parsing jobs |

---

## What to Delete from NuGetGallery

<Warning>
  These items will not exist in the AIpkg repo. Delete them when setting up the fork.
</Warning>

| Category | Items to Delete |
|----------|----------------|
| V2/OData public API | All `ODataV1`, `ODataV2` controllers and routes |
| OWIN | All OWIN startup, middleware, and pipeline code |
| Autofac | All Autofac container setup, modules, and registrations |
| Razor views | All `.cshtml` files, `_ViewImports`, `_Layout`, tag helpers |
| jQuery / Bootstrap scripts | All `.js` and `.css` bundle files from old MVC stack |
| Symbol packages | `NuGet.Services.Symbols.*`, all snupkg handling code |
| Functional tests | `NuGetGallery.FunctionalTests.sln` and related projects |
| Python tooling | All `.py` scripts in the repo |
| Legacy migrations | EF migration history predating the SLNX rewrite |

---

## What to Keep and Adapt

| Category | Keep | Adaptation |
|----------|------|------------|
| V3 API logic | Registration, flatcontainer, search, push, autocomplete | Rename, update schemas |
| CDN stats jobs | `src/Stats.*` | Adapt for `.aipkg` download events |
| GitHub vulnerability jobs | `src/GitHubVulnerabilities2Db/` | Adapt package ID resolution |
| PBKDF2 API key system | Auth/ApiKeyV4 logic | Port to new project |
| Azure Blob storage abstraction | `ICoreFileStorageService` | Rename types |
| Azure AI Search integration | `NuGet.Services.AzureSearch` | New document model |
| License scanning jobs | `src/NuGet.Jobs.Validation.PackageSigning.*` | Evaluate; lower priority |

---

## Solution Structure

<Note>
  The new solution file is `AIpkg.slnx` (SLNX format). Do **not** convert the existing `NuGetGallery.sln`. The SLNX is created from scratch.
</Note>

```
AIpkg.slnx
├── src/
│   ├── AIpkg.Core/                  # Shared library (see spec 06)
│   ├── AIpkg.Server/                # ASP.NET Core 10 web app (API + Blazor)
│   ├── AIpkg.Server.Db/             # SQL Server Database Project (.sqlproj)
│   ├── AIpkg.Server.Data/           # EasyAF-generated EF Core entities + repositories
│   ├── AIpkg.Server.Search/         # Azure AI Search integration
│   ├── AIpkg.CLI/                   # aipkg CLI (Native AOT) — see spec 06
│   └── AIpkg.Jobs/                  # Background jobs (stats, vulnerability, catalog)
├── tests/
│   ├── AIpkg.Core.Tests/
│   ├── AIpkg.Server.Tests/
│   └── AIpkg.Server.Integration.Tests/
└── src/AIPkg.Docs/specs/
    └── (this directory)
```

---

## V3 Public API

<Note>
  The public API is V3-only. All endpoints are under `/v3/` and return JSON. There is no V1, V2, or OData on the public surface.
</Note>

### Service Index

```http
GET /v3/index.json
```

Returns the service index. Same format as NuGet V3 service index, updated for AIpkg resource types.

```json
{
  "@context": { "@vocab": "http://schema.nuget.org/services#" },
  "version": "3.0.0",
  "resources": [
    {
      "@id": "https://aipkg.org/v3/registration/",
      "@type": "RegistrationsBaseUrl/3.6.0",
      "comment": "Base URL for package registration blobs."
    },
    {
      "@id": "https://aipkg.org/v3/flatcontainer/",
      "@type": "PackageBaseAddress/3.0.0",
      "comment": "Base URL for package downloads."
    },
    {
      "@id": "https://aipkg.org/v3/search",
      "@type": "SearchQueryService/3.5.0",
      "comment": "Search endpoint with APM and capability filters."
    },
    {
      "@id": "https://aipkg.org/v3/autocomplete",
      "@type": "SearchAutocompleteService/3.5.0",
      "comment": "Autocomplete for package IDs."
    },
    {
      "@id": "https://aipkg.org/v3/package",
      "@type": "PackagePublish/2.0.0",
      "comment": "Package push endpoint."
    },
    {
      "@id": "https://aipkg.org/v3/platforms",
      "@type": "PlatformList/1.0.0",
      "comment": "List of known AI Platform Monikers."
    }
  ]
}
```

### Registration

```http
GET /v3/registration/{id}/index.json
GET /v3/registration/{id}/{lower-version}.json
```

Returns package registration data. Uses paged blobs identical to NuGet registration blobs, but with updated JSON-LD schema fields:

- Replace `packageTypes` → `capabilities`
- Replace `targetFrameworks` → `targets` (APM monikers)
- Add `permissions`, `mcpServers`, `modelCompatibility`
- Remove: `requireLicenseAcceptance`, `developmentDependency`, `semVerLevel`

### Flat Container (Downloads)

```http
GET /v3/flatcontainer/{id}/index.json
→ { "versions": ["1.0.0", "1.1.0", "2.0.0"] }

GET /v3/flatcontainer/{id}/{version}/{id}.{version}.aipkg
→ 200 application/x-aipkg  (binary stream)

GET /v3/flatcontainer/{id}/{version}/{id}.{version}.aispec
→ 200 application/json  (manifest only, unzipped)
```

<Tip>
  The `.aispec` endpoint lets clients read manifest metadata without downloading the full archive.
</Tip>

### Search

```http
GET /v3/search
```

**Query Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `q` | string | Full-text search query |
| `skip` | integer | Pagination offset (default: 0) |
| `take` | integer | Page size (default: 20, max: 100) |
| `prerelease` | boolean | Include pre-release versions (default: false) |
| `apm` | string | Filter by AI Platform Moniker (uses fallback graph expansion) |
| `capability` | string | Filter by capability value |
| `permission` | string | Filter by declared permission |

**Response:**

```json
{
  "@context": { "@vocab": "http://schema.nuget.org/services#" },
  "totalHits": 142,
  "data": [
    {
      "@id": "https://aipkg.org/v3/registration/git-helpers/index.json",
      "@type": "Package",
      "id": "git-helpers",
      "version": "1.0.0",
      "description": "A collection of Git workflow skills for AI coding assistants.",
      "authors": ["Jane Developer"],
      "capabilities": ["skill"],
      "targets": ["claude-code", "copilot-vscode", "cursor"],
      "tags": ["git", "workflow"],
      "totalDownloads": 8432,
      "verified": false,
      "versions": [
        { "version": "0.9.0", "@id": "...", "downloads": 1200 },
        { "version": "1.0.0", "@id": "...", "downloads": 7232 }
      ]
    }
  ]
}
```

### Autocomplete

```http
GET /v3/autocomplete?q={prefix}&take={n}
→ { "totalHits": 5, "data": ["git-helpers", "git-flow", ...] }

GET /v3/autocomplete?id={id}&prerelease=false
→ { "totalHits": 3, "data": ["1.0.0", "1.1.0", "2.0.0"] }
```

### Package Push

```http
PUT /v3/package
Authorization: ApiKey {key}
Content-Type: multipart/form-data

Body: multipart with the .aipkg file
```

**Success:** `201 Created` with `Location: /v3/registration/{id}/{version}.json`

**Error responses:**

| Code | Condition |
|------|-----------|
| 400 | Invalid package (validation failure, malformed archive, missing manifest) |
| 401 | Missing or invalid API key |
| 403 | API key does not have push permission for this package ID |
| 409 | Version already exists |
| 413 | Archive exceeds 512 MB size limit |

### Package Delete (Unlist)

```http
DELETE /v3/package/{id}/{version}
Authorization: ApiKey {key}
```

Marks the version as unlisted (sets `listed: false`). Does not physically delete the package from storage. Returns `204 No Content`.

### Platform List

```http
GET /v3/platforms
```

```json
{
  "version": "1.0.0",
  "platforms": [
    {
      "moniker": "claude-code",
      "displayName": "Claude Code",
      "parent": "claude",
      "installPath": ".claude/",
      "stability": "stable"
    },
    {
      "moniker": "cursor",
      "displayName": "Cursor",
      "parent": "ai",
      "installPath": ".cursor/",
      "stability": "stable"
    }
  ]
}
```

### Per-Platform Install Manifest

```http
GET /v3/registration/{id}/{version}/install/{apm}
```

Returns the list of files that would be installed for a given APM, with their source paths resolved through the fallback graph. Allows clients to preview what they will receive before downloading the full archive.

```json
{
  "id": "git-helpers",
  "version": "1.0.0",
  "apm": "claude-code",
  "resolvedChain": ["apm/claude-code", "apm/claude", "apm/ai", "shared"],
  "files": [
    {
      "sourcePath": "shared/prompts/base-prompt.md",
      "installPath": ".claude/prompts/base-prompt.md",
      "resolvedFrom": "shared"
    },
    {
      "sourcePath": "apm/claude-code/skills/my-tool.md",
      "installPath": ".claude/plugins/git-helpers/skills/my-tool.md",
      "resolvedFrom": "apm/claude-code"
    }
  ]
}
```

---

## EasyAF Data Layer

EasyAF (easyaf.dev) provides:

<CardGroup cols={2}>
  <Card title="SQL Server DB Project" icon="database">
    The `.sqlproj` is the authoritative schema. No hand-written EF migrations.
  </Card>
  <Card title="Entity Generation" icon="code">
    EasyAF CLI reads the `.sqlproj` and generates EF Core 10 entity classes.
  </Card>
  <Card title="Repository Generation" icon="layer-group">
    Standard CRUD repository classes are generated, reducing boilerplate.
  </Card>
  <Card title="OData Restier" icon="lock">
    Used exclusively for the internal admin/management API surface. Not exposed publicly.
  </Card>
</CardGroup>

### Data Layer Projects

```
AIpkg.Server.Db/          (.sqlproj)
  Tables/
    Packages.sql
    PackageVersions.sql
    PackageOwners.sql
    Users.sql
    ApiKeys.sql
    Downloads.sql

AIpkg.Server.Data/        (generated by EasyAF)
  Entities/
    Package.cs            ← generated from Packages.sql
    PackageVersion.cs     ← generated from PackageVersions.sql
  Repositories/
    PackageRepository.cs  ← generated CRUD
  AIpkgDbContext.cs       ← generated EF Core DbContext
```

### Schema Change Workflow

<Steps>
  <Step title="Edit SQL files">
    Edit `.sql` files in `AIpkg.Server.Db/`.
  </Step>
  <Step title="Regenerate entities">
    Run EasyAF codegen to regenerate entities in `AIpkg.Server.Data/`.
  </Step>
  <Step title="Publish DB project">
    Publish the `.sqlproj` to the target database (generates and runs migration scripts).
  </Step>
  <Step title="Commit changes">
    Commit both `.sqlproj` changes and regenerated entity files.
  </Step>
</Steps>

---

## Authentication

<Tabs>
  <Tab title="GitHub OAuth">
    Used for web UI login. Scope: `read:user`, `user:email`.

    Port the existing GitHub OAuth flow from NuGetGallery. No structural changes.
  </Tab>
  <Tab title="API Keys (PBKDF2)">
    Used for `aipkg push` and programmatic access. Port the existing `ApiKeyV4` PBKDF2 system:

    - Keys are hashed (PBKDF2-SHA256) on creation; plaintext is never stored
    - Keys have scopes: `push`, `push:new-packages`, `unlist`
    - Keys have expiry (max 365 days)
    - Keys can be scoped to specific package ID prefixes
  </Tab>
  <Tab title="OIDC (Post-MVP)">
    Add generic OIDC provider support for enterprise use cases. Implemented post-MVP alongside GitHub OAuth.
  </Tab>
</Tabs>

---

## Storage

Azure Blob Storage containers:

| Container | Contents |
|-----------|----------|
| `aipkg-packages` | `.aipkg` archive files |
| `aipkg-manifests` | Extracted `.aispec` files (for fast manifest reads) |
| `aipkg-registration` | Registration JSON blobs (V3 registration pages) |
| `aipkg-icons` | Extracted and resized package icons |
| `aipkg-readmes` | Extracted README files |

---

## Search Index

Azure AI Search index: `aipkg-packages`

| Field | Type | Searchable | Filterable | Sortable |
|-------|------|------------|------------|----------|
| `id` | string | yes | yes | yes |
| `version` | string | no | no | no |
| `title` | string | yes | no | no |
| `description` | string | yes | no | no |
| `authors` | string[] | yes | yes | no |
| `tags` | string[] | yes | yes | no |
| `capabilities` | string[] | no | yes | no |
| `targets` | string[] | no | yes | no |
| `permissions` | string[] | no | yes | no |
| `totalDownloads` | int64 | no | no | yes |
| `lastPublished` | DateTimeOffset | no | yes | yes |
| `listed` | bool | no | yes | no |
| `verified` | bool | no | yes | no |

---

## Background Jobs

| Job | Source | Adaptation |
|-----|--------|-----------|
| CDN stats parsing | `src/Stats.*` | Parse `.aipkg` download events |
| GitHub vulnerability | `src/GitHubVulnerabilities2Db/` | Adapt package ID resolution |
| Search index sync | NuGet.Services.AzureSearch | New document model |
| Registration blob builder | Catalog2Registration | Updated JSON-LD schema |
| License scanning | Validation jobs | Evaluate; lower priority |

---

## Non-Functional Requirements

| Requirement | Target |
|-------------|--------|
| Package push latency | < 10s for packages < 10 MB |
| Search query p99 | < 500ms |
| Registration blob cache TTL | 5 minutes |
| Package download | Streaming; no buffering in server memory |
| API rate limiting | 100 req/min per IP (unauthenticated), 1,000/min (authenticated) |
| Max concurrent pushes per key | 5 |
